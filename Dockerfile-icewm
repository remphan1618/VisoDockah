# Base image with CUDA and cuDNN
FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

# Metadata and environment setup
ENV REFRESHED_AT 2024-08-12
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Pacific/Auckland
ARG HOME_DIR=/workspace
ENV HOME=${HOME_DIR}
ENV DISPLAY=:1
ENV VNC_PORT=5901
ENV NO_VNC_PORT=6901
ENV TRT_HOME=/workspace/VisoMaster/tensorrt_engine
ENV PATH=${TRT_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${TRT_HOME}/lib:${LD_LIBRARY_PATH}

# Install essential packages upfront
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget git python3 python3-pip \
    icewm tigervnc-standalone-server firefox \
    ffmpeg fonts-wqy-zenhei && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Setup workspace and copy essential files
WORKDIR ${HOME}
COPY ./src/debian/icewm/wm_startup.sh ${HOME}/
RUN chmod +x ${HOME}/wm_startup.sh
COPY ./src/vnc_startup_jupyterlab_filebrowser.sh /dockerstartup/vnc_startup.sh
RUN chmod +x /dockerstartup/vnc_startup.sh

# Create directories in a single layer
RUN mkdir -p \
    ${HOME}/VisoMaster/model_assets \
    ${HOME}/VisoMaster/Image \
    ${HOME}/VisoMaster/Video \
    ${HOME}/VisoMaster/Output

# Clone VisoMaster repository
RUN git clone -b v0.1.6 https://github.com/visomaster/VisoMaster.git ${HOME}/VisoMaster

# Install Python dependencies
WORKDIR ${HOME}/VisoMaster
RUN pip install --no-cache-dir torch==2.4.1+cu124 --index-url https://download.pytorch.org/whl/cu124 && \
    pip install --no-cache-dir -r requirements_cu124.txt && \
    pip uninstall -y onnxruntime-gpu && \
    pip install --no-cache-dir onnxruntime-gpu==1.19.0 && \
    pip cache purge

# Download and prepare assets
RUN wget -O inswapper_128_fp16.onnx https://huggingface.co/Red1618/Viso/resolve/main/inswapper_128_fp16.onnx?download=true && \
    cp inswapper_128_fp16.onnx ${HOME}/VisoMaster/model_assets/ && \
    rm -f inswapper_128_fp16.onnx

RUN mkdir -p ${HOME}/VisoMaster/tensorrt_engine && \
    wget -O TensorRT.tar.gz https://huggingface.co/Red1618/Viso/resolve/main/TensorRT-10.9.0.34.Linux.x86_64-gnu.cuda-12.8.tar.gz?download=true && \
    tar -xzf TensorRT.tar.gz -C ${HOME}/VisoMaster/tensorrt_engine --strip-components=1 && \
    rm -f TensorRT.tar.gz

RUN wget -O dependencies.zip https://github.com/visomaster/visomaster-assets/releases/download/v0.1.0_dp/dependencies.zip && \
    mkdir -p ${HOME}/VisoMaster/dependencies && \
    unzip dependencies.zip -d ${HOME}/VisoMaster/dependencies && \
    rm -f dependencies.zip

# Clean up to minimize image size
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Expose ports
EXPOSE $VNC_PORT $NO_VNC_PORT 8080 8585

# Start VNC and JupyterLab
ENTRYPOINT ["/dockerstartup/vnc_startup.sh"]
CMD ["--wait"]
